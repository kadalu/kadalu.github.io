<!DOCTYPE HTML>
<html lang="en">
    <head>
        
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title> | Kadalu </title>
<link href="/static/css/fav.png" rel="icon" type="image/x-icon" />
<link rel="apple-touch-icon" href="/static/css/fav.png" />
<meta name="generator" content="Nanoc 4.12.1">
<meta property="og:title" content=""/>
<meta name="author" content=""/>
<meta property="og:locale" content="en_US"/>
<meta name="description" content=""/>
<meta property="og:description" content=""/>
<link rel="canonical" href="/docs/k8s-storage/devel/openshift-monitoring/"/>
<meta property="og:url" content="/docs/k8s-storage/devel/openshift-monitoring/"/>
<meta property="og:site_name" content="Kadalu"/>
<meta property="og:image" content=""/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content=""/>
<meta name="twitter:card" content="summary_large_image"/>
<meta property="twitter:image" content=""/>
<meta property="twitter:title" content=""/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="stylesheet" href="/static/css/stylesheet.css">
<link rel="stylesheet" href="/static/css/syntax-highlight-emacs.css">
<script defer data-domain="kadalu.github.io" src="https://plausible.io/js/plausible.js"></script>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer></script>

    </head>
    <body>
        

<div class="bg-indigo-900">
    <div class="w-full px-5  m-auto py-5">
        <div class="lg:grid lg:grid-cols-12" x-data="{ menuOpen : false }">
            <div class="col-span-4 lg:col-span-2" style="height:40px">
                <a href="/"><img src="/static/css/logo.png" class="h-10 float-left" /></a>
                <button @click="menuOpen = !menuOpen" class="block absolute md:hidden right-7 top-5 w-8 h-8 text-gray-200 p-1">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="pt-2 col-span-8 lg:col-span-10">
                <nav class="absolute md:relative top-16 left-0 md:top-0 z-20 md:flex flex-col-reverse md:flex-row-reverse md:space-x-3 font-semibold w-full md:w-auto bg-indigo-900 shadow-md rounded-lg md:rounded-none md:shadow-none md:bg-transparent p-6 pt-5 md:p-0"
                     :class="{ 'flex' : menuOpen , 'hidden' : !menuOpen}"  @click.away="menuOpen = false"
                >
                    <a href="/blog" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Blog</a>
                    <a href="/opensource" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Open Source</a>
                    <a href="/docs" class="bg-gray-900 text-white py-2 px-3 rounded-md text-sm font-medium">Docs</a>
                </nav>
            </div>
        </div>
    </div>
</div>

        
        <div class="flex flex-col md:grid md:grid-cols-12 w-full" x-data="{docMenuOpen: false}">
            <div class="col-span-3 bg-gray-100" :class="{ 'block mr-10' : docMenuOpen , 'hidden md:block' : !docMenuOpen}" @click.away="docMenuOpen = false">
                <div class="py-5 px-5">
                    
                    <div class="p-5 bg-gray-200 border text-right rounded-lg">
                        <strong>Version: </strong>
                        <select class="input-field" onchange="location = '/docs/k8s-storage/' + this.value;">
                            <option  value="latest">latest</option>
                            
                            <option selected value="devel">devel</option>
                            
                        </select>
                    </div>
                    
                    <h2 class="text-xl font-semibold mt-7">User Guide</h2>
                    <ul>
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/quick-start/">Quick Start</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/quick-start-yaml/">Quick Start YAML</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/introduction/">Introduction</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/setup/">Setup</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/using-with-private-container-registry/">Using with Private Container Registry</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/setup-storage/">Setup Storage</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/csi-to-claim-persistent-volumes/">CSI to claim Persistent Volumes</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/try-kadalu/">Try Kadalu</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/external-gluster-storage/">External Gluster Storage</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/storage-config-options/">Storage Config Options</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/block-volume/">Block Volume</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/storage-classes/">Storage Classes</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/troubleshooting/">Troubleshooting</a></li>
                        
                        
                    </ul>
                    
                    <h2 class="text-xl font-semibold mt-7">Use cases</h2>
                    <ul>
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/running-a-webserver/">Running a Webserver</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/running-minio/">Running Minio</a></li>
                        
                        
                    </ul>
                    
                    <h2 class="text-xl font-semibold mt-7">Articles</h2>
                    <ul>
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/how-it-works?/">How it works?</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/gluster-and-kadalu/">Gluster and Kadalu</a></li>
                        
                        
                    </ul>
                    
                    <h2 class="text-xl font-semibold mt-7">Developer Guide</h2>
                    <ul>
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/docs/k8s-storage/devel/get-involved/">Get Involved</a></li>
                        
                        
                    </ul>
                    
                    
                    
                </div>
            </div>
            <div id="main" class="col-span-9">
                <div class="py-5 px-10">
                    
                    <div class="mb-10">
                        <span class="inline-block font-semibold text-gray-700 py-1 text-xl">
                            <a href="/">
                                <svg class="w-6 h-6 inline-block" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg></a> / <a href="/docs/k8s-storage">k8s-storage</a> / <a href="/docs/k8s-storage/devel">devel</a> / openshift-monitoring/</span>
                    </div>
                    
                    <button @click="docMenuOpen = !docMenuOpen" class="block md:hidden w-8 h-8 text-gray-600 mb-5">
                        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="mb-24 prose max-w-none prose-indigo">
                        <h1>Setup Monitoring of Kadalu in Openshift &amp; OKD 4.X clusters</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide will assist you in collecting metrics &amp; performance data into Openshift/OKD Prometheus.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enable_user_workload_monitoring">Enable user workload monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Follow the official documentation for enabling user workload monitoring.
This is a sample from OKD4.10 and it should be used as a guidance only.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code># In this example we also use Kadalu as persistent storage of Prometheus.
# If you use another storage class for that -&gt; set only "enableUserWorkload"

$ oc -n openshift-monitoring edit configmap cluster-monitoring-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-monitoring-config
  namespace: openshift-monitoring
data:
  config.yaml: |
    enableUserWorkload: true
    prometheusK8s:
      volumeClaimTemplate:
       metadata:
         name: prometheusdb
       spec:
         storageClassName: kadalu.gluster
         accessModes:
           - ReadWriteMany
         resources:
           requests:
             storage: 50Gi
    alertmanagerMain:
      volumeClaimTemplate:
       metadata:
         name: alertmanager
       spec:
         storageClassName: kadalu.gluster
         accessModes:
           - ReadWriteMany
         resources:
           requests:
             storage: 50Gi

$ oc  -n openshift-user-workload-monitoring  edit configmap user-workload-monitoring-config

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: user-workload-monitoring-config
  namespace: openshift-user-workload-monitoring
data:
  config.yaml: |</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_apply_the_following_manifest">Apply the following manifest:</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>---
kind: Namespace
apiVersion: v1
metadata:
  name: kadalu
  labels:
    openshift.io/cluster-monitoring: "true"
---
kind: Service
apiVersion: v1
metadata:
  name: operator
  namespace: kadalu
  labels:
    name: kadalu
spec:
  selector:
    name: kadalu
  ports:
    - name: kadalu-metrics
      protocol: TCP
      port: 8050
      targetPort: 8050
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kadalu-metrics
  namespace: kadalu
  labels:
    name: kadalu
spec:
  endpoints:
    - path: /metrics
      port: kadalu-metrics
      scheme: http
      bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
      tlsConfig:
        insecureSkipVerify: true
  selector:
    matchLabels:
      name: kadalu</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set_necessary_permissions">Set necessary permissions.</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Assign a relevant role for the service account (I&#8217;m using 'kadalu-operator' as we do not have a viewer role, yet):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>oc policy add-role-to-user kadalu-operator system:serviceaccount:openshift-monitoring:prometheus-k8s -n kadalu</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Verify the rolebinding</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>$ oc -n kadalu get rolebinding kadalu-operator -o yaml

apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"rbac.authorization.k8s.io/v1","kind":"RoleBinding","metadata":{"annotations":{},"creationTimestamp":"2022-04-13T14:39:10Z","name":"kadalu-operator","namespace":"kadalu","resourceVersion":"42934554","uid":"f8ce8d9f-b5cd-46c1-98bc-bde6dff0ecca"},"roleRef":{"apiGroup":"rbac.authorization.k8s.io","kind":"ClusterRole","name":"kadalu-operator"},"subjects":[{"kind":"ServiceAccount","name":"prometheus-k8s","namespace":"openshift-monitoring"}]}
  creationTimestamp: "2022-04-13T14:39:10Z"
  name: kadalu-operator
  namespace: kadalu
  resourceVersion: "49108675"
  uid: f8ce8d9f-b5cd-46c1-98bc-bde6dff0ecca
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kadalu-operator
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: openshift-monitoring</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verify_that_the_target_is_being_scraped">Verify that the target is being scraped:</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Obtain the endpoints of the service</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>$ oc -n kadalu  describe  services operator | awk '/Endpoints/ {print "http://"$2}'</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to the UI &#8594; Administrator &#8594; Observe &#8594; Targets</p>
</li>
<li>
<p>Go to the UI &#8594; Administrator &#8594; Observe &#8594; Metrics &#8594; Type "kadalu_" &#8594; There should be multiple metrics</p>
</li>
<li>
<p>In case you got troubles with the Metrics, consider setting "openshift.io/cluster-monitoring" to "false" and back to "true" and if needed restarting the pods in the openshift-user-workload-monitoring namespace (and in rare cases openshift-monitoring)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_alarm_configuration">Alarm configuration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Once the Metrics are visible in the UI, you can setup some alerts.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code># Create and apply this manifest:
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kadalu-alert
  namespace: kadalu

spec:
  groups:
  - name: PVC-Space-alerts
    rules:
    - alert: PvcFreeSpaceLow
      annotations:
        description: PVC space is low!
      expr: kadalu_pvc_free_capacity_bytes &lt; 1.073741824e+10
      labels:
        severity: warning
    - alert: PvcFreeSpaceCritical
      annotations:
        description: PVC space is critical!
      expr: kadalu_pvc_free_capacity_bytes &lt; 0.536870912e+10
      labels:
        severity: critical
  - name: PVC-inode-alerts
    rules:
    - alert: PVCFreeInodesLow
      annotations:
        description: PVC Free inodes is low!
      expr: kadalu_pvc_free_inodes &lt; 500000
      labels:
        severity: warning
    - alert: PVCFreeInodesCritical
      annotations:
        description: PVC Free inodes is critical!
      expr: kadalu_pvc_free_inodes &lt; 200000
      labels:
        severity: critical</code></pre>
</div>
</div>
</div>
</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-gray-800 text-gray-100 py-10">
    <div class="mx-auto w-full px-5 " style="min-height: 40vh">
        <div class="md:grid gap-2 md:grid-cols-4 md:gap-4">
            <div class="mb-10">
                <h2 class="text-xl font-semibold text-indigo-300">Community</h2>
                <ul>
                    <li><a href="/opensource">Open Source</a></li>
                    <li><a href="https://join.slack.com/t/kadalu/shared_invite/enQtNzg1ODQ0MDA5NTM2LWMzMTc5ZTJmMjk4MzI0YWVhOGFlZTJjZjY5MDNkZWI0Y2VjMDBlNzVkZmI1NWViN2U3MDNlNDJhNjE5OTBlOGU">Slack</a></li>
                    <li><a href="https://github.com/kadalu">Github</a></li>
                </ul>
            </div>

            <div class="mb-10">
                <h2 class="text-xl font-semibold text-indigo-300">Learn</h2>
                <ul>
                    <li><a href="/docs">Documentation</a></li>
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/faq">FAQ</a></li>
                    <li><a href="/rfcs">RFCs</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="bg-gray-800 text-gray-100 py-10">
    <div class="mx-auto w-3/4 text-center text-gray-300 mb-10">
        &copy; 2022 Kadalu Community(https://github.com/kadalu). All Rights Reserved.
    </div>
</div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144588868-2"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-144588868-2');
</script>


    </body>
</html>
