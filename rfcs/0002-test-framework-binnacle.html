<!DOCTYPE HTML>
<html lang="en">
    <head>
        
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title> | Kadalu </title>
<link href="/static/css/fav.png" rel="icon" type="image/x-icon" />
<link rel="apple-touch-icon" href="/static/css/fav.png" />
<meta name="generator" content="Nanoc 4.12.1">
<meta property="og:title" content=""/>
<meta name="author" content=""/>
<meta property="og:locale" content="en_US"/>
<meta name="description" content=""/>
<meta property="og:description" content=""/>
<link rel="canonical" href="/rfcs/0002-test-framework-binnacle.html"/>
<meta property="og:url" content="/rfcs/0002-test-framework-binnacle.html"/>
<meta property="og:site_name" content="Kadalu"/>
<meta property="og:image" content=""/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content=""/>
<meta name="twitter:card" content="summary_large_image"/>
<meta property="twitter:image" content=""/>
<meta property="twitter:title" content=""/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="stylesheet" href="/static/css/stylesheet.css">
<link rel="stylesheet" href="/static/css/syntax-highlight-emacs.css">
<script defer data-domain="kadalu.github.io" src="https://plausible.io/js/plausible.js"></script>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer></script>

    </head>
    <body>
        

<div class="bg-indigo-900">
    <div class="w-full px-5  m-auto py-5">
        <div class="lg:grid lg:grid-cols-12" x-data="{ menuOpen : false }">
            <div class="col-span-4 lg:col-span-2" style="height:40px">
                <a href="/"><img src="/static/css/logo.png" class="h-10 float-left" /></a>
                <button @click="menuOpen = !menuOpen" class="block absolute md:hidden right-7 top-5 w-8 h-8 text-gray-200 p-1">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="pt-2 col-span-8 lg:col-span-10">
                <nav class="absolute md:relative top-16 left-0 md:top-0 z-20 md:flex flex-col-reverse md:flex-row-reverse md:space-x-3 font-semibold w-full md:w-auto bg-indigo-900 shadow-md rounded-lg md:rounded-none md:shadow-none md:bg-transparent p-6 pt-5 md:p-0"
                     :class="{ 'flex' : menuOpen , 'hidden' : !menuOpen}"  @click.away="menuOpen = false"
                >
                    <a href="/blog" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Blog</a>
                    <a href="/opensource" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Open Source</a>
                    <a href="/docs" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Docs</a>
                </nav>
            </div>
        </div>
    </div>
</div>

        
        <div class="flex flex-col md:grid md:grid-cols-12 w-full" x-data="{docMenuOpen: false}">
            <div class="col-span-3 bg-gray-100" :class="{ 'block mr-10' : docMenuOpen , 'hidden md:block' : !docMenuOpen}" @click.away="docMenuOpen = false">
                <div class="py-5 px-5">
                    
                    
                    <ul>
                        
                        <li class="py-2 md:py-0"><a href="/rfcs">Introduction</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0001-external-gluster-storage.html">0001 External Gluster Storage</a></li>
                        
                        
                        
                        
                        <li class="text-indigo-600 font-semibold py-2 md:py-0">0002 Test Framework Binnacle</li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0003-kadalu-thin-arbiter-support.html">0003 Kadalu Thin Arbiter Support</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0004-gluster-error-codes.html">0004 Gluster Error Codes</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0005-external-control-plane-gluster.html">0005 External Control Plane Gluster</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0006-optimized-quota-feature-with-namespace.html">0006 Optimized Quota Feature With Namespace</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0007-Using-GlusterFS-directory-quota-for-external-gluster-volumes.html">0007 Using Glusterfs Directory Quota For External Gluster Volumes</a></li>
                        
                        
                        
                    </ul>
                    
                </div>
            </div>
            <div id="main" class="col-span-9">
                <div class="py-5 px-10">
                    
                    <button @click="docMenuOpen = !docMenuOpen" class="block md:hidden w-8 h-8 text-gray-600 mb-5">
                        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="mb-24 prose max-w-none prose-indigo">
                        <h1>Test Framework - Binnacle</h1>
<div class="sect1">
<h2 id="_authors">Authors</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Aravinda Vishwanathapura &lt;<a href="mailto:aravinda@kadalu.io">aravinda@kadalu.io</a>&gt;</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_license">License</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Binnacle is licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Proposal for a Test framework with the focus for Tester&#8217;s delight!</p>
</div>
<div class="paragraph">
<p>Automating tests in a distributed setup is always hard. Binnacle aims
to simplify the ergonomics so that a tester without Programming
language expertise can adapt to this quickly.</p>
</div>
<div class="paragraph">
<p>If someone knows which command to test, then write that command with
the prefix <code>TEST</code>. For example, the command <code>touch
/var/www/html/index.html</code> tries to create a file inside the directory
to see if it succeeds. To convert this into a test case, write as
below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre># File: hello.t
TEST touch /var/www/html/index.html</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it! Run the test file using the binnacle command, and it gives
the beautiful Output as below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>binnacle hello.t
<span class="go">hello.t .. ok
All tests successful.
Files=1, Tests=1,  0 wallclock secs ( 0.03 usr  0.01 sys +  0.07 cusr  0.05 csys =  0.16 CPU)
Result: PASS</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The verbose(<code>-v</code>) Output gives other useful details about executed
command and error lines in case of errors.</p>
</div>
<div class="paragraph">
<p>Learning the new programming language is not required to write test
cases.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: This framework is not for Unit testing</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_features">Features</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="#Multi-node-support">Multi node support</a></p>
</li>
<li>
<p><a href="#Bash-style-variable-substitution">Bash style variable substitution</a></p>
</li>
<li>
<p><a href="#Validate-Return-code">Validate Return code</a></p>
</li>
<li>
<p><a href="#Validate-the-return-value">Validate the return value</a></p>
</li>
<li>
<p><a href="#To-check-if-any-expected-value-from-the-Output">To check if any expected value from the Output</a></p>
</li>
<li>
<p><a href="#Timeout-for-tests">Timeout for tests</a></p>
</li>
<li>
<p><a href="#Pipelines">Pipelines</a></p>
</li>
<li>
<p><a href="#Extending-functionalities-by-writing-Python-function-or-Bash-function">Extending functionalities by writing Python function or Bash function</a></p>
</li>
<li>
<p><a href="#Recording-Output-of-a-command">Recording Output of a command</a></p>
</li>
<li>
<p><a href="#Loop">Loop</a></p>
</li>
<li>
<p><a href="#Ease-of-use">Ease of use</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="Multi-node-support">Multi-node support</h3>
<div class="paragraph">
<p>Just specify <code>NODE=&lt;nodename&gt;</code> before any test to run in that
node. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NODE=node1.example.com
TEST command1
TEST command2

NODE=node2.example.com
TEST command3</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Passwordless SSH access is required from the current node
for all the nodes which are specified in Tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="Bash-style-variable-substitution">Bash style variable substitution</h3>
<div class="listingblock">
<div class="content">
<pre>VOLNAME=gv1
TEST gluster volume start ${VOLNAME}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Validate-Return-code">Validate Return code</h3>
<div class="paragraph">
<p><code>TEST</code> helper validates the return code of the command, for example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TEST stat /etc/glusterfs/glusterd.vol</pre>
</div>
</div>
<div class="paragraph">
<p>Above command is equivalent to the following bash script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>stat /etc/glusterfs/glusterd.vol
if [ $? -eq 0 ]
then
    echo "SUCCESS"
else
    echo "FAIL"
fi</pre>
</div>
</div>
<div class="paragraph">
<p>To test other return code use <code>--ret=&lt;return-code&gt;</code>. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TEST --ret=1 stat /non/existing/file</pre>
</div>
</div>
<div class="paragraph">
<p>To test the return code is not some value. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TEST --not=0 stat /non/existing/file</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Validate-the-return-value">Validate the return value</h3>
<div class="paragraph">
<p>To verify the Output of commands, <code>EXPECT</code> can be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>EXPECT -v 10 wc -l /test/output</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="To-check-if-any-expected-value-from-the-Output">To check if any expected value from the Output</h3>
<div class="listingblock">
<div class="content">
<pre>EXISTS "127.0.0.1 node1.example.com" cat /etc/hosts</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Timeout-for-tests">Timeout for tests</h3>
<div class="paragraph">
<p>All the utilities discussed above have a variant with <code>_WITHIN</code>
suffix. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TEST_WITHIN -t 60 stat /path/to/pid/file
EXPECT_WITHIN -t 10 wc -l /test/output</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Pipelines">Pipelines</h3>
<div class="paragraph">
<p>Pass Output of one command to other function using <code>|</code>. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TEST cat /etc/hosts | grep "node1.example.com"</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Extending-functionalities-by-writing-Python-function-or-Bash-function">Extending functionalities by writing Python function or Bash function</h3>
<div class="paragraph">
<p>The name of command after <code>TEST</code> or any other utilities can be a
Python function. For example, below command calls Python/bash function
<code>brick_kill</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NODE=node2.example.com
TEST brick_kill "/exports/bricks/${volname}/brick2/brick"</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Make sure to use the function name different than the actual
command. For example, if a function is created as <code>gluster</code> then that
function will get called instead of actual Gluster command.</p>
</div>
</div>
<div class="sect2">
<h3 id="Recording-Output-of-a-command">Recording Output of a command</h3>
<div class="paragraph">
<p>Sometimes we can&#8217;t run the same command multiple times, but Output
needs to be verified multiple times. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TEST gluster volume info --record-output /tmp/status.dat
EXPECT -v 2 grep "ID:" /tmp/info.dat | wc -l
EXPECT -v 1 grep "Status:" /tmp/info.dat | grep "Running" | wc -l</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Loop">Loop</h3>
<div class="paragraph">
<p>Repeating tests are straightforward to implement, define <code>LOOP_DATA</code>
as JSON, and then use indentation to define loop tasks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>LOOP_DATA="""
[
    {
        "node": "node1.example.com",
        "device": "/dev/vdc"
    },
    {
        "node": "node2.example.com",
        "device": "/dev/vdc"
    },
    {
        "node": "node3.example.com",
        "device": "/dev/vdc"
    }
]
"""

LOOP:
    NODE=$node
    TEST mkfs.xfs $device</pre>
</div>
</div>
<div class="paragraph">
<p>In case of external JSON data,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>LOOP_DATA_FILE=device_config.json
LOOP:
    NODE=$node
    TEST mkfs.xfs $device</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ease-of-use">Ease of use</h3>
<div class="paragraph">
<p>No special syntax. The example below is to test the Gluster Volume
force start command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>N1=node1.example.com
N2=node2.example.com
N3=node3.example.com
volname=gv1

NODE=$N1
TEST gluster volume create ${volname} \
    $N1:/exports/bricks/${volname}/brick1/brick \
    $N2:/exports/bricks/${volname}/brick2/brick
TEST gluster volume start ${volname}
TEST_WITHIN -t 60 gluster volume status ${volname} | match_num_bricks_online 2

NODE=$N2
TEST brick_kill "/exports/bricks/${volname}/brick2/brick"

NODE=$N1
TEST_WITHIN -t 60 gluster volume status ${volname} | match_num_bricks_online 1
TEST gluster volume start ${volname} force
TEST_WITHIN -t 60 gluster volume status ${volname} | match_num_bricks_online 2</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kadalu_test_example">Kadalu Test example</h3>
<div class="listingblock">
<div class="content">
<pre>MASTER=master.example.com
N1=kube-node1.example.com
N2=kube-node2.example.com
N3=kube-node3.example.com
STORAGE_POOL_NAME=sp1
OPERATOR_YAML=operator.yaml
PVC_NAME=pv1
PVC_FILE_NAME=pv1.yaml
APP_POD_NAME=pod1
APP_POD_FILE=pod1.yaml

NODE=$MASTER
TEST kube_master_setup --record-output tmp/master-details.json

LOOP_DATA="""
[
  {
    "node": "$N1",
    "device": "/dev/vdc"
  },
  {
    "node": "$N2",
    "device": "/dev/vdc"
  },
  {
    "node": "$N3",
    "device": "/dev/vdc"
  }
]
"""
LOOP:
    NODE=$node
    TEST kube_node_setup
    TEST join_kube_master tmp/master-details.json
    TEST loop_device_setup $device

NODE=$MASTER
TEST kubectl create -f $OPERATOR_YAML
EXPECT_WITHIN -t 180 -v 3 kubectl get pods -n kadalu | grep "Running" | wc -l
TEST kubectl kadalu storage-add $STORAGE_POOL_NAME --type Replica3 \
    --device $N1:/dev/vdc
    --device $N2:/dev/vdc
    --device $N3:/dev/vdc
EXPECT_WITHIN -t 180 -v 3 kubectl get pods -n kadalu | grep $STORAGE_POOL_NAME | wc -l

# Sample PVC Test
TEST kubectl create -f $PVC_FILE
EXPECT_WITHIN -t 60 -v 1 kubectl get pvc | grep $PVC_NAME | grep Bound | wc -l

# Sample app Test
TEST kubectl create -f $APP_POD_FILE
EXPECT_WITHIN -t 180 -v 1 kubectl get pods | grep $APP_POD_NAME | grep Running | wc -l</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_it_works">How it works?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Similar to Gluster upstream tests, Binnacle uses <a href="https://en.wikipedia.org/wiki/Test_Anything_Protocol">Test Anything Protocol(TAP)</a>. This
test framework provides syntax sugar on top of the shell script.</p>
</div>
<div class="paragraph">
<p>Binnacle generates shell script from the given test file and then
executes the generated script using
<a href="https://metacpan.org/pod/distribution/Test-Harness/bin/prove">prove</a>
command.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_functions">Core functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Core functions like <code>TEST</code>, <code>EXPECT</code>, <code>EXISTS</code> etc. will be written
using Python and bash. These functions print the Output in TAP format
so that prove tool can understand it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_binnacle_test_to_shell_script_conversion">Binnacle test to Shell script conversion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A few special syntaxes used are not valid bash script. Those need to
be converted. For example, Pipe character needs to be escaped
otherwise, <code>TEST</code> only runs the first part, and all other commands
will be run based on the TEST output instead of the first command’s
Output.</p>
</div>
<div class="paragraph">
<p>Similarly, the utility file needs to be included in every test file to
understand <code>TEST</code>, <code>EXPECT</code>, and other functions.</p>
</div>
<div class="paragraph">
<p>Loop syntax used in the test file needs to be expanded into a valid
bash script.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_different_from_gluster_upstream_tests">How is this different from Gluster upstream Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are inspired by the Gluster upstream regression tests, which use shell
scripts for writing test cases. Binnacle provides an additional layer
on top of shell scripts for ease of use. In addition to ease of use,
Binnacle also offers the following features compared to the Gluster
tests framework.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multi-node support</p>
</li>
<li>
<p>Plugin support - Extend/add the functionalities easily using Python/Bash</p>
</li>
<li>
<p>Detailed easy to parse Output in verbose mode</p>
</li>
<li>
<p>Ease of use</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code_repository">Code repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/kadalu/binnacle" class="bare">https://github.com/kadalu/binnacle</a> will be
the project repository for the Binnacle project. While running, it
looks for plugins in <code>~/.local/lib/binnacle/plugins</code> directory.</p>
</div>
<div class="paragraph">
<p>Binnacle repository will not contain Test cases and plugins specific
to different projects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_known_issues">Known issues</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The test framework will not work on the Windows operating
system. Windows support can be adopted in the future but not a
priority for now.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation">Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Not yet started.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thanks">Thanks</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Thanks <a href="https://github.com/sac">Sac</a>, for suggesting the beautiful
name for the test framework and valuable inputs for the design.</p>
</li>
<li>
<p>Thanks <a href="https://github.com/amarts">Amar</a>, for the valuable inputs to
the design of this framework with more emphasis on ease of use.</p>
</li>
</ul>
</div>
</div>
</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-gray-800 text-gray-100 py-10">
    <div class="mx-auto w-full px-5 " style="min-height: 40vh">
        <div class="md:grid gap-2 md:grid-cols-4 md:gap-4">
            <div class="mb-10">
                <h2 class="text-xl font-semibold text-indigo-300">Community</h2>
                <ul>
                    <li><a href="/opensource">Open Source</a></li>
                    <li><a href="https://join.slack.com/t/kadalu/shared_invite/enQtNzg1ODQ0MDA5NTM2LWMzMTc5ZTJmMjk4MzI0YWVhOGFlZTJjZjY5MDNkZWI0Y2VjMDBlNzVkZmI1NWViN2U3MDNlNDJhNjE5OTBlOGU">Slack</a></li>
                    <li><a href="https://github.com/kadalu">Github</a></li>
                </ul>
            </div>

            <div class="mb-10">
                <h2 class="text-xl font-semibold text-indigo-300">Learn</h2>
                <ul>
                    <li><a href="/docs">Documentation</a></li>
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/faq">FAQ</a></li>
                    <li><a href="/rfcs">RFCs</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="bg-gray-800 text-gray-100 py-10">
    <div class="mx-auto w-3/4 text-center text-gray-300 mb-10">
        &copy; 2022 Kadalu Community(https://github.com/kadalu). All Rights Reserved.
    </div>
</div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144588868-2"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-144588868-2');
</script>


    </body>
</html>
