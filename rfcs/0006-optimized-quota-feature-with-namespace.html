<!DOCTYPE HTML>
<html lang="en">
    <head>
        
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title> | Kadalu </title>
<link href="/static/css/fav.png" rel="icon" type="image/x-icon" />
<link rel="apple-touch-icon" href="/static/css/fav.png" />
<meta name="generator" content="Nanoc 4.12.1">
<meta property="og:title" content=""/>
<meta name="author" content=""/>
<meta property="og:locale" content="en_US"/>
<meta name="description" content=""/>
<meta property="og:description" content=""/>
<link rel="canonical" href="/rfcs/0006-optimized-quota-feature-with-namespace.html"/>
<meta property="og:url" content="/rfcs/0006-optimized-quota-feature-with-namespace.html"/>
<meta property="og:site_name" content="Kadalu"/>
<meta property="og:image" content=""/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content=""/>
<meta name="twitter:card" content="summary_large_image"/>
<meta property="twitter:image" content=""/>
<meta property="twitter:title" content=""/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="stylesheet" href="/static/css/stylesheet.css">
<link rel="stylesheet" href="/static/css/syntax-highlight-emacs.css">
<script defer data-domain="kadalu.io" src="https://plausible.io/js/plausible.js"></script>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer></script>

    </head>
    <body>
        

<div class="bg-indigo-900">
    <div class="w-full px-5  m-auto py-5">
        <div class="lg:grid lg:grid-cols-12" x-data="{ menuOpen : false }">
            <div class="col-span-4 lg:col-span-2" style="height:40px">
                <a href="/"><img src="/static/css/logo.png" class="h-10 float-left" /></a>
                <button @click="menuOpen = !menuOpen" class="block absolute md:hidden right-7 top-5 w-8 h-8 text-gray-200 p-1">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="pt-2 col-span-8 lg:col-span-10">
                <nav class="absolute md:relative top-16 left-0 md:top-0 z-20 md:flex flex-col-reverse md:flex-row-reverse md:space-x-3 font-semibold w-full md:w-auto bg-indigo-900 shadow-md rounded-lg md:rounded-none md:shadow-none md:bg-transparent p-6 pt-5 md:p-0"
                     :class="{ 'flex' : menuOpen , 'hidden' : !menuOpen}"  @click.away="menuOpen = false"
                >
                    <a href="/blog" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Blog</a>
                    <a href="/company" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Company</a>
                    <a href="/opensource" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Open Source</a>
                    <a href="/services" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Services</a>
                    <a href="/products" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Products</a>
                    <a href="/docs" class="text-gray-300 hover:bg-gray-700 hover:text-white py-4 md:py-2 px-3 rounded-md text-sm font-medium">Docs</a>
                </nav>
            </div>
        </div>
    </div>
</div>

        
        <div class="flex flex-col md:grid md:grid-cols-12 w-full" x-data="{docMenuOpen: false}">
            <div class="col-span-3 bg-gray-100" :class="{ 'block mr-10' : docMenuOpen , 'hidden md:block' : !docMenuOpen}" @click.away="docMenuOpen = false">
                <div class="py-5 px-5">
                    
                    
                    <ul>
                        
                        <li class="py-2 md:py-0"><a href="/rfcs">Introduction</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0001-external-gluster-storage.html">0001 External Gluster Storage</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0002-test-framework-binnacle.html">0002 Test Framework Binnacle</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0003-kadalu-thin-arbiter-support.html">0003 Kadalu Thin Arbiter Support</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0004-gluster-error-codes.html">0004 Gluster Error Codes</a></li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0005-external-control-plane-gluster.html">0005 External Control Plane Gluster</a></li>
                        
                        
                        
                        
                        <li class="text-indigo-600 font-semibold py-2 md:py-0">0006 Optimized Quota Feature With Namespace</li>
                        
                        
                        
                        
                        <li class="py-2 md:py-0"><a href="/rfcs/0007-Using-GlusterFS-directory-quota-for-external-gluster-volumes.html">0007 Using Glusterfs Directory Quota For External Gluster Volumes</a></li>
                        
                        
                        
                    </ul>
                    
                </div>
            </div>
            <div id="main" class="col-span-9">
                <div class="py-5 px-10">
                    
                    <button @click="docMenuOpen = !docMenuOpen" class="block md:hidden w-8 h-8 text-gray-600 mb-5">
                        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="mb-24 prose max-w-none prose-indigo">
                        <h1>Optimized lazy Quota at subdirectory level</h1>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GlusterFS&#8217;s quota implementation is having major performance issues. It is
expressed by many users. When we proposed to drop quota feature from fs, many
users requested for this feature, even though it has perf issues, because it
solves some genuine problems for them, and is a required feature for their
deployments.</p>
</div>
<div class="paragraph">
<p>We need quota in our kadalu deployments too, and for now we are using xfs quota
support.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A good quota implementation in glusterfs itself, would allow more adoption
of gluster project, and also it benefits kadalu deployments immensely, by
allowing a true distributed replicate volume to be present.</p>
</div>
<div class="paragraph">
<p>Just by looking at top level, there seems to be many possibilities, if we allow
some limitations to creep in. That is, lets not do a quota which would solve
every possible usecase, but solves few usecases very efficiently.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_detailed_design">Detailed design</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At very top level, the current proposal tries to make only minimal changes to
current quota design, and hence expect it to work smoothly with the deployments.
This RFC doesn&#8217;t mandate any implementation guidelines on management layer,
considering kadalu&#8217;s vision of better management tool with
<a href="https://github.com/kadalu/moana">moana project</a>.</p>
</div>
<div class="paragraph">
<p>With this new proposal, I believe the performance can be optimized to
a large extent. To let you know the impact, current day quota has almost
250% hit from regular deployments, where as the new one would have anywhere
between 5-10% hit. And code changes would also be minimal.</p>
</div>
<div class="paragraph">
<p>So, the toplevel change includes below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instead of current filelevel xattrop update of consumption, all the
consumptions would be tracked at the namespace (or quota dir) level.</p>
</li>
<li>
<p>namespaces would be implemented at the 'server-resolve' level, so
every inode would know which namespace it belongs to.</p>
</li>
<li>
<p>Getting and setting quota exhaust information can happen just through
statfs() and setxattr() respectively, instead of new service, RPC etc!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Well, that looks very minimal changes at the conceptual level. Lets look into
what the implementation would be like.</p>
</div>
<div class="sect2">
<h3 id="_introduction_of_namespace_or_project_inside_of_the_volume">Introduction of 'namespace' or 'project' inside of the volume.</h3>
<div class="paragraph">
<p>We had gotten introduced to some concept of a namespace earlier from facebook team, this is similar, but my proposal is to introduce it at the inode scope (ie, for entire process) instead of a translator level. The idea is, every inode should have an information of which namespace it belongs to.</p>
</div>
<div class="paragraph">
<p>It can be achieved by having it at 'resolve' level. In glusterfs, while operations are possible with just a single gfid, filesystem with fuse mount itself would send 'lookup()' on all parent path in most of the case, so the top down path resolution would happen in 'resolve'.</p>
</div>
<div class="paragraph">
<p>We will start with root ('/') inode as the namespace for entire filesystem. for all other paths, while 'resolve' modules does 'lookup()', we can send few keys which mandates for a separate namespace (like quota limit, etc). If the lookup returns these keys, then we can create a new namspace for the inode. If not, the inode will inherit the parent inode&#8217;s namespace. At present it is assumed that, the namespace pointer will be inode itself of the namespace.</p>
</div>
<div class="paragraph">
<p>This way, during resolve itself the namespace information is built in. Getting this work complete is very critical for the proposal to realize.</p>
</div>
<div class="paragraph">
<p>This also needs a minor update to the way server-resolve happens today. We would need complete path to be resolved when a gfid based lookup is done for the first time. Which also means, memory consumption on server side would increase by a bit! (ie, all namespace inodes would be in cache without lru limit impacting them).</p>
</div>
</div>
<div class="sect2">
<h3 id="_changes_in_marker_quota">Changes in 'marker-quota'</h3>
<div class="paragraph">
<p>This module wouldn&#8217;t be required, and the marker-quota feature can be merged to Quota itself.</p>
</div>
</div>
<div class="sect2">
<h3 id="_changes_in_quota">Changes in Quota</h3>
<div class="paragraph">
<p>This module would see some changes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement the 'marker-quota' feature in here (just to update the namespace)</p>
</li>
<li>
<p>Remove quotad RPC code</p>
</li>
<li>
<p>The global consumption info can be just in memory! (Even if the process restarts, the service which should update global info should update the process as soon as it connects.</p>
</li>
<li>
<p>Make sure df (ie, statfs()) is properly implemented.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_new_quota_update_service">New quota update service!</h3>
<div class="paragraph">
<p>Just run <code>statfs()</code> on all dirs which has Quota set, and send a flag to update status of quota xlator through internal xattr mechanism if quota limit exceeds for a directory! This can run once in 5 or 10 seconds, or even lesser frequency if the quota limit is huge!</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In future the frequency can also be dependent on how much of limit is left, say if just 1GB is pending, then update can happen every 2-5 seconds, but if the limit is 1TB, then update can happen once a minute or even slower!</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_management_layer_changes">Management layer changes</h3>
<div class="ulist">
<ul>
<li>
<p>Considering the namespace resolution needs to be handled at brick side, when a quota limit is set, every brick (or brick process) should have the limit information sent.</p>
<div class="ulist">
<ul>
<li>
<p>This can be done by xattr, so brick gets it, and also is preserved!</p>
</li>
</ul>
</div>
</li>
<li>
<p>Advised method is adding quota limit info before writing any information to directory. Even otherwise we don&#8217;t need quota crawl for updating quota-limit, but do a <code>du -s -b $dir</code> and write the output into xattr.</p>
</li>
<li>
<p>No need to write dir info to volfile, which means no graph switch problems.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_changes_to_dht_statfs">Changes to DHT statfs</h3>
<div class="ulist">
<ul>
<li>
<p>If Quota is set (or not), implement a mechanism to send 'almost realistic' information when one of the subvol is completely down!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, if there are 5 subvols, and each with 10TB storage bricks&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Now assume one node is down, and out of other 4 nodes, we got statfs as 23TB / 40TB consumed. Now, do the math, add ~60% of consumption from the node which was down! that way, instead of showing less size for the whole filesystem, the system reports, ~30TB / 50TB, which in <strong>most</strong> of the cases can be right! And also we can put disclaimer in log that this is done to make sure we provide better information to users!</p>
</div>
<div class="paragraph">
<p>And if quota set (ie, deem-statfs), then total remains same, but the consumption increases! even here, the same above rule should apply!</p>
</div>
</div>
</div>
</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-gray-800 text-gray-100 py-10">
    <div class="mx-auto w-full px-5 " style="min-height: 40vh">
        <div class="md:grid gap-2 md:grid-cols-4 md:gap-4">
            <div class="mb-10">
                <h2 class="text-xl font-semibold text-indigo-300">Kadalu</h2>
                <ul>
                    <li><a href="/products#k8s-native-storage">Kubernetes native Storage</a></li>
                    <li><a href="/products#kadalu-storage">Kadalu Storage</a></li>
                    <li><a href="/products#glusterup">GlusterFS monitoring</a></li>
                    <li><a href="/services">Services</a></li>
                    <li><a href="/services#features">Feature development</a></li>
                    <li><a href="/services#upgrade">Upgrade assistance</a></li>
                    <li><a href="/services#consultancy">Consultancy</a></li>
                    <li><a href="/security">Security</a></li>
                </ul>
            </div>

            <div class="mb-10">
                <h2 class="text-xl font-semibold text-indigo-300">Community</h2>
                <ul>
                    <li><a href="/opensource">Open Source</a></li>
                    <li><a href="https://join.slack.com/t/kadalu/shared_invite/enQtNzg1ODQ0MDA5NTM2LWMzMTc5ZTJmMjk4MzI0YWVhOGFlZTJjZjY5MDNkZWI0Y2VjMDBlNzVkZmI1NWViN2U3MDNlNDJhNjE5OTBlOGU">Slack</a></li>
                    <li><a href="https://github.com/kadalu">Github</a></li>
                    <!-- <li><a href="/office-hours">Office Hours</a></li> -->
                </ul>
            </div>

            <div class="mb-10">
                <h2 class="text-xl font-semibold text-indigo-300">Learn</h2>
                <ul>
                    <li><a href="/docs">Documentation</a></li>
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/faq">FAQ</a></li>
                    <li><a href="/rfcs">RFCs</a></li>
                    <!-- <li><a href="/compare">Compare</a></li> -->
                </ul>
            </div>

            <div class="mb-10">
                <h2 class="text-xl font-semibold text-indigo-300">Company</h2>
                <ul>
                    <li><a href="/company">About</a></li>
                    <li><a href="/contact">Contact</a></li>
                    <li><a href="/sitemap.xml">Sitemap</a></li>
                </ul>

                <h2 class="text-xl font-semibold text-indigo-300 mt-10">Write to us</h2>
                <ul>
                    <li><a href="mailto:hello@kadalu.io"><svg class="w-4 h-4 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>hello@kadalu.io</a></li>
                </ul>

                <h2 class="text-xl font-semibold text-indigo-300 mt-10">Follow Us</h2>
                <ul>
                    <li><a href="https://twitter.com/kadaluio">Twitter</a></li>
                    <li><a href="https://linkedin.com/company/kadalu-io">Linkedin</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="bg-gray-800 text-gray-100 py-10">
    <div class="mx-auto w-3/4 text-center text-gray-300 mb-10">
        &copy; 2022 Kadalu Software Private Limited. All Rights Reserved.
    </div>
</div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144588868-2"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-144588868-2');
</script>


    </body>
</html>
